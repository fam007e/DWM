#!/bin/bash

# Succinct DWM keybindings script with dynamic description extraction
DWM_REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
DWM_CONFIG_PATH="$DWM_REPO_DIR/config.h"
[ ! -f "$DWM_CONFIG_PATH" ] && DWM_CONFIG_PATH="$DWM_REPO_DIR/config.def.h"

[ ! -f "$DWM_CONFIG_PATH" ] && echo "Error: Config not found" && exit 1

awk '
BEGIN { FS="[{},]"; modkey="SUPER"; IGNORECASE=1 }

# Find MODKEY definition
/^#define MODKEY/ { modkey=($3=="Mod4Mask"?"SUPER":($3=="Mod1Mask"?"ALT":"SUPER")) }

# Start/Stop parsing arrays
/^static Key keys\[\]/ { in_keys=1; next }
/^static Button buttons\[\]/ { in_buttons=1; next }
/^};/ { in_keys=in_buttons=0 }

# Parse bindings
(in_keys || in_buttons) && $0 ~ /\{/ && !/TAGKEYS/ {
    # Extract comment if present
    comment=""
    if (match($0, /\/\*.*\*\//)) comment=substr($0, RSTART+2, RLENGTH-4)
    gsub(/^[ \t]+|[ \t]+$/, "", comment)

    # Clean parts
    split($0, p, ",")
    for(i in p) gsub(/[ \t{}]+/, "", p[i])

    # Logic for Keys vs Buttons
    if (in_keys) { mod=p[1]; key=p[2]; fn=p[3]; arg=p[4] }
    else { area=p[1]; mod=p[2]; key=p[3]; fn=p[4]; arg=p[5] }

    # Format Modifiers
    gsub(/MODKEY/, modkey, mod); gsub(/ControlMask/, "CTRL", mod)
    gsub(/ShiftMask/, "SHIFT", mod); gsub(/Mod1Mask/, "ALT", mod)
    gsub(/Mod4Mask/, "SUPER", mod); gsub(/\|/, " ", mod)
    if (mod == "0") mod=""

    # Format Key/Button names
    gsub(/XK_|XF86XK_|Button/, "", key)
    if (key == "Return") key="Enter"

    # Determine Description
    desc = comment
    if (desc == "") {
        if (fn == "spawn") {
            # Handle SHCMD("...") or SHCMD ("...")
            if (match($0, /SHCMD[ \t]*\([ \t]*"[^"]+"[ \t]*\)/)) {
                cmd_part = substr($0, RSTART, RLENGTH)
                match(cmd_part, /"[^"]+"/)
                desc = substr(cmd_part, RSTART + 1, RLENGTH - 2)
                split(desc, da, " "); desc = da[1]
                sub(/.*\//, "", desc); desc = "Run: " desc
            } else if (arg ~ /\.v=/) {
                # Handle {.v = termcmd}
                sub(/.*\.v=/, "", arg); desc = "Launch " arg
            } else desc = "Spawn " fn
        } else {
            desc = fn
            # Simple beautification: togglebar -> toggle bar
            gsub(/stack|bar|view|tag|mon|mouse|fact|client|warm/, " &", desc)
            gsub(/^ +/, "", desc)
        }
    }

    # Format for Rofi
    combo = (in_keys ? mod " + " key : area " + " mod " + " key)
    gsub(/^[ +]+|[ +]+$/, "", combo)

    # Escape for XML
    for(i=1;i<=2;i++) { v=(i==1?combo:desc); gsub(/&/,"\\&amp;",v); gsub(/</,"\\&lt;",v); gsub(/>/,"\\&gt;",v); if(i==1)combo=v; else desc=v }

    if (combo != "") printf "<b>%-25s</b>  <i>%s</i>\n", combo, desc
}
' "$DWM_CONFIG_PATH" | sort -u | rofi -dmenu -i -markup-rows -p "DWM Keybindings:"
