#!/bin/sh

# Fetch weather data from OpenWeather API
# Get your API key from https://openweathermap.org/api
API_KEY="<YOUR_API_KEY>"
# Get your latitude and longitude from https://www.latlong.net/
LAT="<YOUR_LATITUDE>"
LON="<YOUR_LONGITUDE>"
WEATHER_URL="https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&appid=${API_KEY}"

# Fetch weather data with timeout
WEATHER_DATA=$(curl -s --connect-timeout 5 "$WEATHER_URL")

# Check if curl succeeded and API returned valid data
if [ -z "$WEATHER_DATA" ] || echo "$WEATHER_DATA" | jq -e .cod >/dev/null 2>&1 && [ "$(echo "$WEATHER_DATA" | jq -r '.cod')" != "200" ]; then
    echo "ó°–‘ N/A"
    exit 1
fi

# Extract weather information using jq
TEMP=$(printf '%s' "$WEATHER_DATA" | jq '.main.temp' -r)
FEELS_LIKE=$(printf '%s' "$WEATHER_DATA" | jq '.main.feels_like' -r)
WEATHER_MAIN=$(printf '%s' "$WEATHER_DATA" | jq '.weather[0].main' -r)
HUMIDITY=$(printf '%s' "$WEATHER_DATA" | jq '.main.humidity' -r)

# Convert temperature from Kelvin to Celsius
TEMP_C=$(printf '%.2f' "$(echo "$TEMP - 273.15" | bc)")
FEELS_LIKE_C=$(printf '%.2f' "$(echo "$FEELS_LIKE - 273.15" | bc)")

# Define icons for weather conditions
case $WEATHER_MAIN in
  Clear) ICON="ó°–™" ;;  # weather-sunny
  "Few Clouds") ICON="ó°–•" ;;  # weather-partly-cloudy
  "Scattered Clouds") ICON="ó°–" ;;  # weather-cloudy
  "Broken Clouds") ICON="ó°–" ;;  # weather-cloudy
  Clouds) ICON="ó°–" ;;  # weather-cloudy
  "Light Rain") ICON="ó°–—" ;;  # weather-rainy
  Rain) ICON="ó°––" ;;  # weather-pouring
  "Heavy Rain") ICON="ó°––" ;;  # weather-pouring
  Drizzle) ICON="ó°–—" ;;  # weather-rainy
  Thunderstorm) ICON="ó°–“" ;;  # weather-lightning
  "Light Snow") ICON="ó°–˜" ;;  # weather-snowy
  Snow) ICON="ó°–˜" ;;  # weather-snowy
  "Heavy Snow") ICON="ó°¼¶" ;;  # weather-snowy-heavy
  Mist|Haze) ICON="ó°–‘" ;;  # weather-fog
  Smoke) ICON="ó°–‘" ;;  # weather-fog
  Dust) ICON="ó°–" ;;  # weather-windy
  Fog) ICON="ó°–‘" ;;  # weather-fog
  Sand) ICON="ó°–" ;;  # weather-windy
  Ash) ICON="ó°–“" ;;  # weather-lightning
  Squall) ICON="ó°–" ;;  # weather-windy
  Tornado) ICON="ó°¼¸" ;;  # weather-tornado
  *) ICON="ó°–™" ;;  # weather-sunny (default)
esac

# Define temperature icons based on Celsius value
if [ "$(printf '%.0f\n' "$(printf '%s > 27\n' "$TEMP_C" | bc)")" -eq 1 ]; then
    TEMP_ICON="î¼ª"  # Above 27Â°C
elif [ "$(printf '%.0f\n' "$(printf '%s >= 20 && %s <= 27\n' "$TEMP_C" "$TEMP_C" | bc)")" -eq 1 ]; then
    TEMP_ICON="ï‹‰"  # Between 20Â°C and 27Â°C
elif [ "$(printf '%.0f\n' "$(printf '%s >= 5 && %s < 18\n' "$TEMP_C" "$TEMP_C" | bc)")" -eq 1 ]; then
    TEMP_ICON="î¼«"  # Between 5Â°C and 18Â°C
else
    TEMP_ICON="ï‹‹"  # Below 5Â°C
fi

# Print weather information in a single line with temperature icon
printf '%s %s%.0fÂ°C(%.0fÂ°C)ðŸ’§%s%%\n' "$ICON" "$TEMP_ICON" "$TEMP_C" "$FEELS_LIKE_C" "$HUMIDITY"
exit 0
